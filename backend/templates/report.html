<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Assessment Report</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans', Arial, sans-serif;
      font-size: 10pt;
      line-height: 1.4;
      color: #000;
      background: white;
      padding: 20px;
    }
    
    h1 {
      font-size: 18pt;
      text-align: center;
      margin-bottom: 20px;
      color: #1a1a1a;
    }
    
    h2 {
      font-size: 14pt;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    h3 {
      font-size: 12pt;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #34495e;
    }
    
    .school-info {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .school-name {
      font-size: 14pt;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .school-code {
      font-size: 11pt;
      color: #555;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: fixed;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    
    th {
      background-color: #f0f0f0;
      font-weight: bold;
      font-size: 9pt;
    }
    
    td {
      font-size: 9pt;
    }
    
    .left-align {
      text-align: left;
    }
    
    .priority-high {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .priority-medium {
      background-color: #fff9c4;
      color: #f57f17;
    }
    
    .priority-low {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    /* Priority distribution table cells */
    .priorityCell {
      padding: 10px 8px;
    }
    
    .priorityHigh {
      background-color: #fde2e2;
      color: #b91c1c;
      font-weight: 700;
      text-align: center;
    }
    
    .priorityMedium {
      background-color: #fff4cc;
      color: #92400e;
      font-weight: 700;
      text-align: center;
    }
    
    .priorityLow {
      background-color: #d1fae5;
      color: #065f46;
      font-weight: 700;
      text-align: center;
    }
    
    .page-break {
      page-break-before: always;
    }
    
    .error {
      color: red;
      font-size: 24pt;
      text-align: center;
      margin: 50px;
    }
  </style>
</head>
<body>
  <script>
    // STEP 4: Validate data
    console.log("PDF DATA", window.__PDF_DATA__);
    
    if (!window.__PDF_DATA__) {
      document.body.innerHTML = '<div class="error">NO DATA RECEIVED</div>';
      throw new Error("PDF data missing");
    }
    
    const data = window.__PDF_DATA__;
    const { school, aggregates, competencies, lang } = data;
    
    if (!school || !school.school_code) {
      document.body.innerHTML = '<div class="error">INVALID SCHOOL DATA</div>';
      throw new Error("School data invalid");
    }
    
    // Competency translation map for Hindi
    const competencyTranslations = {
      "Writing Clear and Organized Ideas": "स्पष्ट और सुव्यवस्थित लेखन",
      "Building Correct Sentences and Using Proper Grammar": "सही वाक्य निर्माण और व्याकरण का प्रयोग",
      "Vocabulary": "शब्दावली",
      "Reading Comprehension": "पठन बोध",
      "Understanding Stories and Poems": "कहानियों और कविताओं की समझ",
      "Lines and Angles": "रेखाएँ और कोण",
      "Perimeter and Area": "परिमाप और क्षेत्रफल",
      "Solving Problems with Numbers": "संख्याओं से समस्याएँ हल करना",
      "Understanding Shapes and Measurement": "आकृतियाँ और मापन की समझ",
      "Understanding and Using Number Properties": "संख्याओं के गुणों की समझ और उपयोग",
      "Understanding and Ordering Numbers": "संख्याओं की समझ और क्रमबद्ध करना",
      "Representing and Interpreting Data": "डेटा का प्रतिनिधित्व और व्याख्या",
      "Solving Problems with Algebra (Unknowns)": "बीजगणित से समस्याएँ हल करना",
      "Working with Fractions and Decimals": "भिन्न और दशमलव के साथ काम करना",
      "Applying Science to Everyday Life": "रोजमर्रा की जिंदगी में विज्ञान का प्रयोग",
      "Making Healthy Food Choices and Identifying Food Components": "स्वस्थ भोजन विकल्प और खाद्य घटकों की पहचान",
      "Understanding Living Organisms and Life Processes": "जीवित जीवों और जीवन प्रक्रियाओं की समझ",
      "Understanding Properties and Changes of Materials": "पदार्थों के गुण और परिवर्तन की समझ",
      "Understanding how magnets work": "चुंबक कैसे काम करते हैं",
      "Ensuring Healthy Plant Growth and Food Safety": "स्वस्थ पौधों की वृद्धि और खाद्य सुरक्षा",
      "Measuring Physical Properties": "भौतिक गुणों को मापना",
      "Understanding Heat and Its Transfer": "गर्मी और इसके स्थानांतरण की समझ",
      "Understanding how materials and weather affect us": "पदार्थ और मौसम हमें कैसे प्रभावित करते हैं",
      "Appreciating India's Cultural and Historical Heritage": "भारत की सांस्कृतिक और ऐतिहासिक विरासत की सराहना",
      "Appreciating Rajasthan's Culture and History": "राजस्थान की संस्कृति और इतिहास की सराहना",
      "Exploring Historical Places and Events": "ऐतिहासिक स्थानों और घटनाओं की खोज",
      "Understanding Community Rules and Rights": "समुदाय के नियम और अधिकार की समझ",
      "Understanding Early Civilizations": "प्रारंभिक सभ्यताओं की समझ",
      "Understanding Natural Environment & Resources": "प्राकृतिक पर्यावरण और संसाधनों की समझ",
      "Analyzing Social Change & Justice": "सामाजिक परिवर्तन और न्याय का विश्लेषण",
      "Exploring Livelihoods in Our Region": "हमारे क्षेत्र में आजीविका की खोज",
      "Understanding Constitutional Rights & Duties": "संवैधानिक अधिकार और कर्तव्यों की समझ",
      "Understanding Economic Development": "आर्थिक विकास की समझ",
      "Understanding Local governance": "स्थानीय शासन की समझ"
    };
    
    // Translations
    const labels = {
      en: {
        title: "School Assessment Report Card",
        gradeTitle: "Grade {grade} Report Card",
        schoolCode: "School Code",
        subjectAvg: "Subject-wise Average Scores",
        subject: "Subject",
        avgScore: "Average Score",
        overall: "Overall School Average",
        english: "English",
        mathematics: "Mathematics",
        science: "Science",
        socialScience: "Social Science",
        priorityDist: "Competency Priority Distribution by Grade",
        grade: "Grade",
        high: "High",
        medium: "Medium",
        low: "Low",
        competency: "Competency",
        score: "Score",
        priority: "Priority",
        noData: "No data",
        legendTitle: "Priority Scale",
        legendHigh: "0–4.9 → High Priority",
        legendMedium: "5.0–6.9 → Medium Priority",
        legendLow: "7.0–10 → Low Priority"
      },
      hi: {
        title: "कक्षा रिपोर्ट कार्ड",
        gradeTitle: "कक्षा {grade} रिपोर्ट कार्ड",
        schoolCode: "विद्यालय कोड",
        subjectAvg: "विषयवार औसत अंक",
        subject: "विषय",
        avgScore: "औसत अंक",
        overall: "समग्र विद्यालय औसत",
        english: "अंग्रेज़ी",
        mathematics: "गणित",
        science: "विज्ञान",
        socialScience: "सामाजिक विज्ञान",
        priorityDist: "ग्रेड के अनुसार दक्षता प्राथमिकता वितरण",
        grade: "ग्रेड",
        high: "उच्च",
        medium: "मध्यम",
        low: "निम्न",
        competency: "दक्षता",
        score: "अंक",
        priority: "प्राथमिकता",
        noData: "डेटा उपलब्ध नहीं",
        legendTitle: "प्राथमिकता स्केल",
        legendHigh: "0–4.9 → उच्च प्राथमिकता",
        legendMedium: "5.0–6.9 → मध्यम प्राथमिकता",
        legendLow: "7.0–10 → निम्न प्राथमिकता"
      }
    };
    
    const t = labels[lang] || labels.en;
    
    // Helper to translate competency names
    function translateCompetency(name) {
      if (lang === 'hi' && competencyTranslations[name]) {
        return competencyTranslations[name];
      }
      return name; // Fallback to English if not found
    }
    
    // Helper functions
    function formatScore(val) {
      if (val === null || val === undefined) return t.noData;
      return Number(val).toFixed(1);
    }
    
    // Get priority class based on priority band enum OR numeric score
    function getPriorityClass(priorityBand, score) {
      // Try band first (more reliable)
      if (priorityBand) {
        const band = priorityBand.toLowerCase();
        if (band === 'high' || band === 'उच्च') return 'priority-high';
        if (band === 'medium' || band === 'मध्यम') return 'priority-medium';
        if (band === 'low' || band === 'निम्न') return 'priority-low';
      }
      // Fallback to score
      if (score !== null && score !== undefined) {
        if (score < 5) return 'priority-high';
        if (score < 7) return 'priority-medium';
        return 'priority-low';
      }
      return '';
    }
    
    function translatePriority(priority) {
      if (!priority || priority === '-') return '-';
      const p = priority.toLowerCase();
      if (p === 'high' || p === 'उच्च') return lang === 'hi' ? 'उच्च' : 'High';
      if (p === 'medium' || p === 'मध्यम') return lang === 'hi' ? 'मध्यम' : 'Medium';
      if (p === 'low' || p === 'निम्न') return lang === 'hi' ? 'निम्न' : 'Low';
      return priority;
    }
    
    // Extract report parameters
    const reportType = data.reportType || 'full'; // 'full' or 'grade'
    const gradeLevel = data.gradeLevel || null; // 6, 7, 8, or null
    
    // DEBUG: Log data structure
    console.log('TEMPLATE_DEBUG:', {
      reportType,
      gradeLevel,
      lang,
      competenciesCount: competencies?.length || 0,
      sampleComp: competencies?.[0],
      sampleSubject: competencies?.[0]?.subject,
      samplePriority: competencies?.[0]?.priority_band
    });
    
    // DEBUG: Check for data consistency between languages
    if (reportType === 'grade' && gradeLevel && competencies && competencies.length === 0) {
      console.error('CRITICAL: Grade report has ZERO competencies', {
        school: school.school_code,
        grade: gradeLevel,
        lang
      });
    }
    
    // Determine title
    let pageTitle = t.title;
    if (reportType === 'grade' && gradeLevel) {
      pageTitle = t.gradeTitle.replace('{grade}', gradeLevel);
    }
    
    // Build HTML
    let html = `
      <h1>${pageTitle}</h1>
      <div class="school-info">
        <div class="school-name">${school.school_name}</div>
        <div class="school-code">${t.schoolCode}: ${school.school_code}</div>
      </div>
    `;
    
    // Add priority scale legend
    html += `
      <div style="background-color: #f9f9f9; border: 1px solid #ddd; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
        <strong>${t.legendTitle}:</strong><br/>
        <span style="color: #c62828;">●</span> ${t.legendHigh}<br/>
        <span style="color: #f57f17;">●</span> ${t.legendMedium}<br/>
        <span style="color: #2e7d32;">●</span> ${t.legendLow}
      </div>
    `;
    
    // Only render summary tables for full school reports
    if (reportType === 'full') {
      // Subject-wise averages
      html += `<h2>${t.subjectAvg}</h2>`;
      html += `<table>
        <thead>
          <tr>
            <th>${t.subject}</th>
            <th>${t.avgScore}</th>
          </tr>
        </thead>
        <tbody>`;
      
      if (aggregates) {
        html += `<tr><td class="left-align"><strong>${t.overall}</strong></td><td>${formatScore(aggregates.overall_avg)}</td></tr>`;
        
        const subjectMap = aggregates.subject_avg_map || {};
        html += `<tr><td class="left-align">${t.english}</td><td>${formatScore(subjectMap.English)}</td></tr>`;
        html += `<tr><td class="left-align">${t.mathematics}</td><td>${formatScore(subjectMap.Mathematics)}</td></tr>`;
        html += `<tr><td class="left-align">${t.science}</td><td>${formatScore(subjectMap.Science)}</td></tr>`;
        html += `<tr><td class="left-align">${t.socialScience}</td><td>${formatScore(subjectMap['Social Science'])}</td></tr>`;
      } else {
        html += `<tr><td colspan="2">${t.noData}</td></tr>`;
      }
      
      html += `</tbody></table>`;
      
      // Competency Priority Distribution
      html += `<h2>${t.priorityDist}</h2>`;
      
      // Calculate priority counts by grade and subject
      // IMPORTANT: Use English keys for data access, not translated keys
      const priorityCounts = {};
      const grades = [6, 7, 8];
      const subjectsEN = ['English', 'Mathematics', 'Science', 'Social Science'];
      
      grades.forEach(grade => {
        priorityCounts[grade] = {};
        subjectsEN.forEach(subject => {
          priorityCounts[grade][subject] = { High: 0, Medium: 0, Low: 0 };
        });
      });
      
      if (competencies && Array.isArray(competencies)) {
        competencies.forEach(comp => {
          const grade = comp.grade_level;
          const subject = comp.subject; // Should always be English key
          const priority = comp.priority_band; // Should always be High/Medium/Low
          
          // Normalize priority band (handle both English and Hindi just in case)
          let normalizedPriority = priority;
          if (priority === 'उच्च') normalizedPriority = 'High';
          if (priority === 'मध्यम') normalizedPriority = 'Medium';
          if (priority === 'निम्न') normalizedPriority = 'Low';
          
          if (priorityCounts[grade] && priorityCounts[grade][subject] && normalizedPriority) {
            priorityCounts[grade][subject][normalizedPriority] = (priorityCounts[grade][subject][normalizedPriority] || 0) + 1;
          }
        });
      }
      
      // Table 1: English + Mathematics
      html += `<table style="margin-bottom: 15px;">
        <thead>
          <tr>
            <th rowspan="2">${t.grade}</th>
            <th colspan="3">${t.english}</th>
            <th colspan="3">${t.mathematics}</th>
          </tr>
          <tr>
            <th>${t.high}</th>
            <th>${t.medium}</th>
            <th>${t.low}</th>
            <th>${t.high}</th>
            <th>${t.medium}</th>
            <th>${t.low}</th>
          </tr>
        </thead>
        <tbody>`;
      
      grades.forEach(grade => {
        const eng = priorityCounts[grade]['English'];
        const math = priorityCounts[grade]['Mathematics'];
        html += `<tr>
          <td>${grade}</td>
          <td class="priorityCell priorityHigh">${eng.High || 0}</td>
          <td class="priorityCell priorityMedium">${eng.Medium || 0}</td>
          <td class="priorityCell priorityLow">${eng.Low || 0}</td>
          <td class="priorityCell priorityHigh">${math.High || 0}</td>
          <td class="priorityCell priorityMedium">${math.Medium || 0}</td>
          <td class="priorityCell priorityLow">${math.Low || 0}</td>
        </tr>`;
      });
      
      html += `</tbody></table>`;
      
      // Table 2: Science + Social Science
      html += `<table>
        <thead>
          <tr>
            <th rowspan="2">${t.grade}</th>
            <th colspan="3">${t.science}</th>
            <th colspan="3">${t.socialScience}</th>
          </tr>
          <tr>
            <th>${t.high}</th>
            <th>${t.medium}</th>
            <th>${t.low}</th>
            <th>${t.high}</th>
            <th>${t.medium}</th>
            <th>${t.low}</th>
          </tr>
        </thead>
        <tbody>`;
      
      grades.forEach(grade => {
        const sci = priorityCounts[grade]['Science'];
        const soc = priorityCounts[grade]['Social Science'];
        html += `<tr>
          <td>${grade}</td>
          <td class="priorityCell priorityHigh">${sci.High || 0}</td>
          <td class="priorityCell priorityMedium">${sci.Medium || 0}</td>
          <td class="priorityCell priorityLow">${sci.Low || 0}</td>
          <td class="priorityCell priorityHigh">${soc.High || 0}</td>
          <td class="priorityCell priorityMedium">${soc.Medium || 0}</td>
          <td class="priorityCell priorityLow">${soc.Low || 0}</td>
        </tr>`;
      });
      
      html += `</tbody></table>`;
    }
    
    // Grade-wise detailed competency tables
    if (competencies && Array.isArray(competencies)) {
      // Determine which grades to render
      const grades = [6, 7, 8];
      const gradesToRender = (reportType === 'grade' && gradeLevel) 
        ? [gradeLevel] 
        : grades;
      // Use English subject keys for data filtering (not translated keys)
      const subjectsEN = ['English', 'Mathematics', 'Science', 'Social Science'];
      
      gradesToRender.forEach((grade, gradeIdx) => {
        const gradeComps = competencies.filter(c => c.grade_level === grade);
        
        console.log(`TEMPLATE: Grade ${grade} has ${gradeComps.length} competencies`);
        
        if (gradeComps.length === 0) {
          console.warn(`TEMPLATE: No competencies for grade ${grade}`);
          return;
        }
        
        // Page break logic: skip for first grade in grade-specific reports, or after grade 6 in full reports
        if (reportType === 'grade') {
          // No page break needed for grade-specific reports (single grade only)
        } else if (gradeIdx > 0) {
          html += '<div class="page-break"></div>';
        }
        
        // Only show grade header for full reports (already in title for grade reports)
        if (reportType === 'full') {
          html += `<h2>${t.grade} ${grade}</h2>`;
        }
        
        subjectsEN.forEach(subjectEN => {
          // Filter using English subject key
          const subjectComps = gradeComps.filter(c => c.subject === subjectEN);
          
          if (subjectComps.length === 0) return;
          
          console.log(`TEMPLATE: Grade ${grade}, Subject ${subjectEN}: ${subjectComps.length} comps`);
          
          // Sort by NUMERIC score (ascending: lower scores = higher priority)
          subjectComps.sort((a, b) => {
            const scoreA = a.score_10 ?? 999;
            const scoreB = b.score_10 ?? 999;
            return scoreA - scoreB;
          });
          
          // Translate subject label for display
          const subjectLabel = {
            'English': t.english,
            'Mathematics': t.mathematics,
            'Science': t.science,
            'Social Science': t.socialScience
          }[subjectEN] || subjectEN;
          
          html += `<h3>${subjectLabel}</h3>`;
          html += `<table>
            <thead>
              <tr>
                <th style="width: 50%">${t.competency}</th>
                <th style="width: 20%">${t.score}</th>
                <th style="width: 30%">${t.priority}</th>
              </tr>
            </thead>
            <tbody>`;
          
          subjectComps.forEach(comp => {
            // Use priority band and score for color
            const priorityClass = getPriorityClass(comp.priority_band, comp.score_10);
            // Translate competency name (backend already translated)
            const displayCompetency = comp.competency_name || '-';
            html += `<tr>
              <td class="left-align">${displayCompetency}</td>
              <td>${formatScore(comp.score_10)}</td>
              <td class="${priorityClass}">${translatePriority(comp.priority_band)}</td>
            </tr>`;
          });
          
          html += `</tbody></table>`;
        });
      });
    }
    
    // Inject HTML
    document.body.innerHTML = html;
  </script>
</body>
</html>
