<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Assessment Report</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans', Arial, sans-serif;
      font-size: 10pt;
      line-height: 1.4;
      color: #000;
      background: white;
      padding: 20px;
    }
    
    h1 {
      font-size: 18pt;
      text-align: center;
      margin-bottom: 20px;
      color: #1a1a1a;
    }
    
    h2 {
      font-size: 14pt;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    h3 {
      font-size: 12pt;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #34495e;
    }
    
    .school-info {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .school-name {
      font-size: 14pt;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .school-code {
      font-size: 11pt;
      color: #555;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: fixed;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    
    th {
      background-color: #f0f0f0;
      font-weight: bold;
      font-size: 9pt;
    }
    
    td {
      font-size: 9pt;
    }
    
    .left-align {
      text-align: left;
    }
    
    .priority-high {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .priority-medium {
      background-color: #fff9c4;
      color: #f57f17;
    }
    
    .priority-low {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .page-break {
      page-break-before: always;
    }
    
    .error {
      color: red;
      font-size: 24pt;
      text-align: center;
      margin: 50px;
    }
  </style>
</head>
<body>
  <script>
    // STEP 4: Validate data
    console.log("PDF DATA", window.__PDF_DATA__);
    
    if (!window.__PDF_DATA__) {
      document.body.innerHTML = '<div class="error">NO DATA RECEIVED</div>';
      throw new Error("PDF data missing");
    }
    
    const data = window.__PDF_DATA__;
    const { school, aggregates, competencies, lang } = data;
    
    if (!school || !school.school_code) {
      document.body.innerHTML = '<div class="error">INVALID SCHOOL DATA</div>';
      throw new Error("School data invalid");
    }
    
    // Translations
    const labels = {
      en: {
        title: "School Assessment Report Card",
        schoolCode: "School Code",
        subjectAvg: "Subject-wise Average Scores",
        subject: "Subject",
        avgScore: "Average Score",
        overall: "Overall School Average",
        english: "English",
        mathematics: "Mathematics",
        science: "Science",
        socialScience: "Social Science",
        priorityDist: "Competency Priority Distribution by Grade",
        grade: "Grade",
        high: "High",
        medium: "Medium",
        low: "Low",
        competency: "Competency",
        score: "Score",
        priority: "Priority",
        noData: "No data"
      },
      hi: {
        title: "विद्यालय मूल्यांकन रिपोर्ट कार्ड",
        schoolCode: "विद्यालय कोड",
        subjectAvg: "विषयवार औसत अंक",
        subject: "विषय",
        avgScore: "औसत अंक",
        overall: "समग्र विद्यालय औसत",
        english: "अंग्रेज़ी",
        mathematics: "गणित",
        science: "विज्ञान",
        socialScience: "सामाजिक विज्ञान",
        priorityDist: "ग्रेड के अनुसार दक्षता प्राथमिकता वितरण",
        grade: "ग्रेड",
        high: "उच्च",
        medium: "मध्यम",
        low: "निम्न",
        competency: "दक्षता",
        score: "अंक",
        priority: "प्राथमिकता",
        noData: "डेटा उपलब्ध नहीं"
      }
    };
    
    const t = labels[lang] || labels.en;
    
    // Helper functions
    function formatScore(val) {
      if (val === null || val === undefined) return t.noData;
      return Number(val).toFixed(1);
    }
    
    // Get priority class based on NUMERIC SCORE (not string)
    function getPriorityClass(score) {
      if (score === null || score === undefined) return '';
      if (score < 5) return 'priority-high';    // Red
      if (score < 7) return 'priority-medium';  // Amber/Yellow
      return 'priority-low';                     // Green
    }
    
    function translatePriority(priority) {
      if (!priority || priority === '-') return '-';
      const p = priority.toLowerCase();
      if (p === 'high') return lang === 'hi' ? 'उच्च' : 'High';
      if (p === 'medium') return lang === 'hi' ? 'मध्यम' : 'Medium';
      if (p === 'low') return lang === 'hi' ? 'निम्न' : 'Low';
      return priority;
    }
    
    // Build HTML
    let html = `
      <h1>${t.title}</h1>
      <div class="school-info">
        <div class="school-name">${school.school_name}</div>
        <div class="school-code">${t.schoolCode}: ${school.school_code}</div>
      </div>
    `;
    
    // Subject-wise averages
    html += `<h2>${t.subjectAvg}</h2>`;
    html += `<table>
      <thead>
        <tr>
          <th>${t.subject}</th>
          <th>${t.avgScore}</th>
        </tr>
      </thead>
      <tbody>`;
    
    if (aggregates) {
      html += `<tr><td class="left-align"><strong>${t.overall}</strong></td><td>${formatScore(aggregates.overall_avg)}</td></tr>`;
      
      const subjectMap = aggregates.subject_avg_map || {};
      html += `<tr><td class="left-align">${t.english}</td><td>${formatScore(subjectMap.English)}</td></tr>`;
      html += `<tr><td class="left-align">${t.mathematics}</td><td>${formatScore(subjectMap.Mathematics)}</td></tr>`;
      html += `<tr><td class="left-align">${t.science}</td><td>${formatScore(subjectMap.Science)}</td></tr>`;
      html += `<tr><td class="left-align">${t.socialScience}</td><td>${formatScore(subjectMap['Social Science'])}</td></tr>`;
    } else {
      html += `<tr><td colspan="2">${t.noData}</td></tr>`;
    }
    
    html += `</tbody></table>`;
    
    // Competency Priority Distribution
    html += `<h2>${t.priorityDist}</h2>`;
    
    // Calculate priority counts by grade and subject
    const priorityCounts = {};
    const grades = [6, 7, 8];
    const subjects = ['English', 'Mathematics', 'Science', 'Social Science'];
    
    grades.forEach(grade => {
      priorityCounts[grade] = {};
      subjects.forEach(subject => {
        priorityCounts[grade][subject] = { High: 0, Medium: 0, Low: 0 };
      });
    });
    
    if (competencies && Array.isArray(competencies)) {
      competencies.forEach(comp => {
        const grade = comp.grade_level;
        const subject = comp.subject;
        const priority = comp.priority_band;
        
        if (priorityCounts[grade] && priorityCounts[grade][subject] && priority) {
          priorityCounts[grade][subject][priority] = (priorityCounts[grade][subject][priority] || 0) + 1;
        }
      });
    }
    
    // Table 1: English + Mathematics
    html += `<table style="margin-bottom: 15px;">
      <thead>
        <tr>
          <th rowspan="2">${t.grade}</th>
          <th colspan="3">${t.english}</th>
          <th colspan="3">${t.mathematics}</th>
        </tr>
        <tr>
          <th>${t.high}</th>
          <th>${t.medium}</th>
          <th>${t.low}</th>
          <th>${t.high}</th>
          <th>${t.medium}</th>
          <th>${t.low}</th>
        </tr>
      </thead>
      <tbody>`;
    
    grades.forEach(grade => {
      const eng = priorityCounts[grade]['English'];
      const math = priorityCounts[grade]['Mathematics'];
      html += `<tr>
        <td>${grade}</td>
        <td>${eng.High || 0}</td>
        <td>${eng.Medium || 0}</td>
        <td>${eng.Low || 0}</td>
        <td>${math.High || 0}</td>
        <td>${math.Medium || 0}</td>
        <td>${math.Low || 0}</td>
      </tr>`;
    });
    
    html += `</tbody></table>`;
    
    // Table 2: Science + Social Science
    html += `<table>
      <thead>
        <tr>
          <th rowspan="2">${t.grade}</th>
          <th colspan="3">${t.science}</th>
          <th colspan="3">${t.socialScience}</th>
        </tr>
        <tr>
          <th>${t.high}</th>
          <th>${t.medium}</th>
          <th>${t.low}</th>
          <th>${t.high}</th>
          <th>${t.medium}</th>
          <th>${t.low}</th>
        </tr>
      </thead>
      <tbody>`;
    
    grades.forEach(grade => {
      const sci = priorityCounts[grade]['Science'];
      const soc = priorityCounts[grade]['Social Science'];
      html += `<tr>
        <td>${grade}</td>
        <td>${sci.High || 0}</td>
        <td>${sci.Medium || 0}</td>
        <td>${sci.Low || 0}</td>
        <td>${soc.High || 0}</td>
        <td>${soc.Medium || 0}</td>
        <td>${soc.Low || 0}</td>
      </tr>`;
    });
    
    html += `</tbody></table>`;
    
    // Grade-wise detailed competency tables
    if (competencies && Array.isArray(competencies)) {
      grades.forEach((grade, gradeIdx) => {
        const gradeComps = competencies.filter(c => c.grade_level === grade);
        
        if (gradeComps.length === 0) return;
        
        if (gradeIdx > 0) {
          html += '<div class="page-break"></div>';
        }
        
        html += `<h2>${t.grade} ${grade}</h2>`;
        
        subjects.forEach(subject => {
          const subjectComps = gradeComps.filter(c => c.subject === subject);
          
          if (subjectComps.length === 0) return;
          
          // Sort by NUMERIC score (ascending: lower scores = higher priority)
          // This works consistently across all languages
          subjectComps.sort((a, b) => {
            const scoreA = a.score_10 ?? 999;
            const scoreB = b.score_10 ?? 999;
            return scoreA - scoreB;
          });
          
          const subjectLabel = {
            'English': t.english,
            'Mathematics': t.mathematics,
            'Science': t.science,
            'Social Science': t.socialScience
          }[subject] || subject;
          
          html += `<h3>${subjectLabel}</h3>`;
          html += `<table>
            <thead>
              <tr>
                <th style="width: 50%">${t.competency}</th>
                <th style="width: 20%">${t.score}</th>
                <th style="width: 30%">${t.priority}</th>
              </tr>
            </thead>
            <tbody>`;
          
          subjectComps.forEach(comp => {
            // Use NUMERIC score for color, not priority string
            const priorityClass = getPriorityClass(comp.score_10);
            html += `<tr>
              <td class="left-align">${comp.competency_name || '-'}</td>
              <td>${formatScore(comp.score_10)}</td>
              <td class="${priorityClass}">${translatePriority(comp.priority_band)}</td>
            </tr>`;
          });
          
          html += `</tbody></table>`;
        });
      });
    }
    
    // Inject HTML
    document.body.innerHTML = html;
  </script>
</body>
</html>
